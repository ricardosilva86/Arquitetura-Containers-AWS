version: 3
abort_on_execution_order_fail: true
projects:
  - name: Network
    dir: ./01_VPC
    workflow: vpc
    autoplan:
      when_modified: [ "*.tf", "environment/dev/terraform.tfvars" ]
  - name: ECS-Cluster
    dir: ./02_ECS_CLUSTER
    workflow: development
    autoplan:
      when_modified: [ "*.tf", "environment/dev/terraform.tfvars" ]
    depends_on: ["Network"]

workflows:
  vpc:
    plan:
      steps:
        - init:
            extra_args: [-backend-config=./01_VPC/environment/dev/backend.tfvars]
        - plan:
            extra_args: ["-var-file", "./01_VPC/environment/dev/terraform.tfvars"]
    apply:
      steps:
        - apply:
            extra_args: [ "-var-file", "./01_VPC/environment/dev/terraform.tfvars" ]
    import:
      steps:
        - init:
            extra_args: [-backend-config=./01_VPC/environment/dev/backend.tfvars]
        - import:
            extra_args: ["-var-file", "./01_VPC/environment/dev/terraform.tfvars"]
  ecs:
    plan:
      steps:
        - init:
            extra_args: [ -backend-config=./02_ECS_CLUSTER/environment/dev/backend.tfvars ]
        - plan:
            extra_args: [ "-var-file", "./02_ECS_CLUSTER/environment/dev/terraform.tfvars" ]
    apply:
      steps:
        - apply:
            extra_args: [ "-var-file", "./02_ECS_CLUSTER/environment/dev/terraform.tfvars" ]
    import:
      steps:
        - init:
            extra_args: [ -backend-config=./02_ECS_CLUSTER/environment/dev/backend.tfvars ]
        - import:
            extra_args: [ "-var-file", "./02_ECS_CLUSTER/environment/dev/terraform.tfvars" ]